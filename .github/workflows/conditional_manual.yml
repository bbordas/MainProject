# This is a basic workflow to help you get started with Actions

name: Conditional Manual

on:
  push:
    branches:
      - '**'
        
  workflow_dispatch:
    inputs:
      projectName:
        description: 'Project name'     
        required: true
        default: 'project1'
      environment:
        description: 'environment'     
        required: true
        default: 'dev'
        
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
      
    - name: Get Git Version
      uses: docker://gittools/gitversion:5.0.2-beta1-27-linux-centos-7-netcoreapp2.2
      with:
        args: /github/workspace /nofetch /exec /bin/sh /execargs "-c \"echo $GitVersion_ShortSha > /github/workspace/version.txt\""
        
    - uses: dorny/paths-filter@v2
      if: steps.check.outcome == 'failure' || steps.check.outcome == 'success'
      id: filter
      with:
        filters: |
          project1:
            - 'projects/project1/**'
          project2:
            - 'projects/project2/**'
          project3:
            - 'projects/project3/**'
      
    - name: Set env variables
      shell: bash
      run: |
        echo "ENV=prod" >> $GITHUB_ENV
        echo "VERSION=$(cat /home/runner/work/MainProject/MainProject/version.txt)" >> $GITHUB_ENV
        
        if steps.filter.outputs.project1 == true
        then
           echo "PROJECT_NAME=project1" >> $GITHUB_ENV
        elif steps.filter.outputs.project2 == true
        then
           echo "PROJECT_NAME=project2" >> $GITHUB_ENV
        elif steps.filter.outputs.project3 == true
        then
           echo "PROJECT_NAME=project3" >> $GITHUB_ENV
        else
          echo "PROJECT_NAME=project1" >> $GITHUB_ENV
          echo "ENV=prod" >> $GITHUB_ENV
        fi

    - name: print out variables
      run: |
        echo $PROJECT_NAME
        echo $ENV
        echo $VERSION
   
  
#     - name: Set up QEMU
#       uses: docker/setup-qemu-action@v1
      
#     - name: Set up Docker Buildx
#       uses: docker/setup-buildx-action@v1

    - name: Login to DockerHub
      uses: docker/login-action@v1 
      with:
        username: ${{ secrets.DOCKERHUB_USER }}
        password: ${{ secrets.DOCKERHUB_PASS }}
        
        
    - name: Build image
      run: | 
          docker build --no-cache --file Dockerfile --tag bbordas/mainproject_$PROJECT_NAME:latest --tag bbordas/mainproject_$PROJECT_NAME:$VERSION --build-arg PROJECT_NAME=$PROJECT_NAME .
      
        
    - name: Push to Docker Hub
      run: | 
          docker push bbordas/mainproject_$PROJECT_NAME:latest
          docker push bbordas/mainproject_$PROJECT_NAME:$VERSION
          
#     - name: Build and push
#       uses: docker/build-push-action@v2
#       with:
#         context: .
#         file: ./Dockerfile
#         build-args: PROJECT_NAME=$PROJECT_NAME
#         no-cache: true 
#         push: true
#         tags: |
#             bbordas/mainproject_$PROJECT_NAME:latest
#             bbordas/mainproject_$PROJECT_NAME:$VERSION
